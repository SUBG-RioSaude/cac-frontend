# Micro-Auth API - Sistema de AutenticaÃ§Ã£o e AutorizaÃ§Ã£o

## ğŸ“‹ VisÃ£o Geral

A **Micro-Auth API** Ã© um sistema robusto de autenticaÃ§Ã£o e autorizaÃ§Ã£o desenvolvido em **.NET 9** com **Entity Framework Core** e **PostgreSQL**. O sistema implementa autenticaÃ§Ã£o de dois fatores (2FA), gerenciamento de sessÃµes, controle de acesso baseado em permissÃµes e integraÃ§Ã£o com mÃºltiplos sistemas.

## ğŸ—ï¸ Arquitetura

- **Framework**: .NET 9
- **ORM**: Entity Framework Core
- **Banco de Dados**: PostgreSQL
- **AutenticaÃ§Ã£o**: JWT (JSON Web Tokens)
- **Criptografia**: AES-256 para dados sensÃ­veis, BCrypt para senhas
- **PadrÃ£o**: REST API com controllers organizados por domÃ­nio

## ğŸ” SeguranÃ§a

### Criptografia e Hash
- **Senhas**: Hash com BCrypt (salt automÃ¡tico)
- **CPF**: Criptografado com AES-256
- **Tokens**: JWT assinado com HMAC-SHA256
- **CÃ³digos 2FA**: Hash SHA-256

### ValidaÃ§Ãµes
- ValidaÃ§Ã£o de CPF com algoritmo oficial
- ValidaÃ§Ã£o de telefone (10-11 dÃ­gitos)
- ValidaÃ§Ã£o de CEP (8 dÃ­gitos)
- ValidaÃ§Ã£o de data de nascimento (13-90 anos)
- ValidaÃ§Ã£o de sexo (M/F/O)

## â° Tempos de ExpiraÃ§Ã£o

| Recurso | DuraÃ§Ã£o | ObservaÃ§Ãµes |
|---------|---------|-------------|
| **JWT Token** | 2 horas | RenovaÃ§Ã£o automÃ¡tica via refresh token |
| **Refresh Token** | 31 dias | Para login normal |
| **Refresh Token** | 7 dias | Para renovaÃ§Ã£o de token |
| **CÃ³digo 2FA** | 10 minutos | CÃ³digo de autenticaÃ§Ã£o por e-mail |
| **Token Troca Senha** | 10 minutos | Token temporÃ¡rio para redefiniÃ§Ã£o |
| **Senha** | 31 dias | ExpiraÃ§Ã£o configurÃ¡vel por usuÃ¡rio |

## ğŸš€ Endpoints da API

### ğŸ”‘ AutenticaÃ§Ã£o (`/api/auth`)

#### 1. **POST** `/api/auth/register`
**Cadastro de novo usuÃ¡rio**

**Request Body:**
```json
{
  "nomeCompleto": "string",
  "email": "string",
  "matricula": "string",
  "cpf": "string",
  "telefone": "string",
  "sexo": "string",
  "dataNascimento": "date",
  "vinculo": "string",
  "unidadeId": "guid",
  "funcaoId": "guid",
  "logradouro": "string",
  "numero": "string",
  "complemento": "string",
  "bairro": "string",
  "cidade": "string",
  "estado": "string",
  "cep": "string",
  "senhaExpiraEm": "date"
}
```

**Response:**
```json
{
  "sucesso": true,
  "dados": {
    "usuarioId": "guid",
    "senhaProvisoria": "string"
  },
  "mensagem": "UsuÃ¡rio cadastrado com sucesso. Senha provisÃ³ria enviada por e-mail."
}
```

**Regras de NegÃ³cio:**
- Gera senha provisÃ³ria forte automaticamente
- Envia credenciais por e-mail com template personalizado
- Valida existÃªncia de unidade e funÃ§Ã£o
- Criptografa CPF antes do armazenamento
- Define `PrecisaTrocarSenha = true` por padrÃ£o

#### 2. **POST** `/api/auth/login`
**InÃ­cio do processo de login**

**Request Body:**
```json
{
  "email": "string",
  "senha": "string",
  "sistemaId": "guid (opcional)"
}
```

**Response:**
```json
{
  "sucesso": true,
  "dados": {
    "mensagem": "CÃ³digo de autenticaÃ§Ã£o enviado para o e-mail.",
    "sistema": {
      "id": "guid",
      "nome": "string",
      "descricao": "string"
    },
    "permissao": "string"
  }
}
```

**Regras de NegÃ³cio:**
- Valida credenciais e status do usuÃ¡rio
- Verifica acesso ao sistema (se especificado)
- Valida perfil completo do usuÃ¡rio
- Gera e envia cÃ³digo 2FA por e-mail
- Verifica expiraÃ§Ã£o de senha

#### 3. **POST** `/api/auth/confirmar-codigo-2fa`
**ConfirmaÃ§Ã£o do cÃ³digo 2FA**

**Request Body:**
```json
{
  "email": "string",
  "codigo": "string"
}
```

**Response (Sucesso):**
```json
{
  "sucesso": true,
  "dados": {
    "token": "string",
    "refreshToken": "string",
    "usuario": {
      "id": "guid",
      "email": "string",
      "nomeCompleto": "string",
      "tipoUsuario": "string",
      "precisaTrocarSenha": false
    }
  }
}
```

**Response (Troca de Senha ObrigatÃ³ria):**
```json
{
  "precisaTrocarSenha": true,
  "message": "Troca de senha obrigatÃ³ria. Informe a nova senha para prosseguir.",
  "tokenTrocaSenha": "string"
}
```

**Regras de NegÃ³cio:**
- Valida cÃ³digo 2FA com expiraÃ§Ã£o de 10 minutos
- Confirma e-mail automaticamente se necessÃ¡rio
- Retorna tokens JWT e refresh token
- Se senha expirada, retorna token temporÃ¡rio para troca

#### 4. **POST** `/api/auth/trocar-senha`
**Troca de senha do usuÃ¡rio**

**Request Body:**
```json
{
  "email": "string",
  "novaSenha": "string",
  "tokenTrocaSenha": "string (opcional)"
}
```

**Response:**
```json
{
  "sucesso": true,
  "dados": {
    "token": "string",
    "refreshToken": "string",
    "usuario": {
      "id": "guid",
      "email": "string",
      "nomeCompleto": "string",
      "tipoUsuario": "string",
      "precisaTrocarSenha": false
    }
  },
  "mensagem": "Senha alterada com sucesso. VocÃª jÃ¡ pode acessar o sistema."
}
```

**Regras de NegÃ³cio:**
- Aceita token de troca de senha (sem JWT)
- Nova senha nÃ£o pode ser igual Ã  anterior
- Define nova expiraÃ§Ã£o de senha (31 dias)
- Remove flag `PrecisaTrocarSenha`

#### 5. **POST** `/api/auth/refresh-token`
**RenovaÃ§Ã£o de token JWT**

**Request Body:**
```json
{
  "refreshToken": "string"
}
```

**Response:**
```json
{
  "sucesso": true,
  "dados": {
    "token": "string",
    "refreshToken": "string",
    "expiresIn": 3600,
    "refreshTokenExpiresIn": 604800,
    "usuario": {
      "id": "guid",
      "email": "string",
      "nomeCompleto": "string",
      "tipoUsuario": "string",
      "emailConfirmado": true,
      "ativo": true
    }
  }
}
```

**Regras de NegÃ³cio:**
- Valida refresh token ativo e nÃ£o expirado
- Verifica confirmaÃ§Ã£o 2FA
- Gera novo JWT (2 horas) e refresh token (7 dias)
- Invalida refresh token anterior

#### 6. **POST** `/api/auth/esqueci-senha`
**SolicitaÃ§Ã£o de redefiniÃ§Ã£o de senha**

**Request Body:**
```json
{
  "email": "string"
}
```

**Response:**
```json
{
  "sucesso": true,
  "dados": "Se o e-mail informado estiver cadastrado, um cÃ³digo de autenticaÃ§Ã£o foi enviado para ele.",
  "mensagem": "CÃ³digo de autenticaÃ§Ã£o enviado."
}
```

**Regras de NegÃ³cio:**
- Sempre retorna mensagem genÃ©rica (seguranÃ§a)
- Gera cÃ³digo 2FA vÃ¡lido por 10 minutos
- Define `PrecisaTrocarSenha = true`
- Envia cÃ³digo por e-mail

#### 7. **POST** `/api/auth/logout`
**Logout seguro**

**Request Body:**
```json
{
  "refreshToken": "string"
}
```

**Response:**
```json
{
  "sucesso": true,
  "dados": "Logout realizado com sucesso.",
  "mensagem": "Logout realizado com sucesso."
}
```

**Regras de NegÃ³cio:**
- Invalida refresh token especÃ­fico
- Sempre retorna sucesso (seguranÃ§a)

#### 8. **POST** `/api/auth/logout-all-sessions`
**Logout de todas as sessÃµes**

**Request Body:**
```json
{
  "refreshToken": "string"
}
```

**Response:**
```json
{
  "sucesso": true,
  "dados": "Logout de todas as sessÃµes realizado com sucesso.",
  "mensagem": "Logout de todas as sessÃµes realizado com sucesso."
}
```

**Regras de NegÃ³cio:**
- Invalida todos os refresh tokens ativos do usuÃ¡rio
- Ãštil para dispositivos perdidos/comprometidos

#### 9. **POST** `/api/auth/sessoes-ativas`
**Lista sessÃµes ativas do usuÃ¡rio**

**Request Body:**
```json
{
  "refreshToken": "string"
}
```

**Response:**
```json
{
  "sucesso": true,
  "dados": {
    "quantidadeSessoes": 3,
    "sessoes": [
      {
        "id": "guid",
        "criadoEm": "datetime",
        "expiracao": "datetime",
        "doisFatoresConfirmado": true,
        "ehSessaoAtual": true
      }
    ]
  }
}
```

### ğŸ‘¥ UsuÃ¡rios (`/api/usuarios`)

#### 1. **GET** `/api/usuarios`
**Lista todos os usuÃ¡rios**

**Response:**
```json
[
  {
    "id": "guid",
    "nome": "string",
    "email": "string",
    "matricula": "string",
    "unidade": "string",
    "status": true,
    "emailConfirmado": true
  }
]
```

#### 2. **GET** `/api/usuarios/{id}`
**ObtÃ©m usuÃ¡rio por ID**

**Response:**
```json
{
  "id": "guid",
  "email": "string",
  "ativo": true,
  "emailConfirmado": true,
  "tipoUsuario": "string",
  "criadoEm": "datetime",
  "atualizadoEm": "datetime",
  "nomeCompleto": "string",
  "matricula": "string",
  "cpf": "string (descriptografado)",
  "telefone": "string",
  "sexo": "char",
  "dataNascimento": "datetime",
  "vinculo": "string",
  "unidadeId": "guid",
  "funcaoId": "guid",
  "enderecoId": "guid",
  "logradouro": "string",
  "numero": "string",
  "complemento": "string",
  "bairro": "string",
  "cidade": "string",
  "estado": "string",
  "cep": "string"
}
```

#### 3. **PUT** `/api/usuarios/{id}`
**Atualiza usuÃ¡rio**

#### 4. **PUT** `/api/usuarios/{id}/ativar`
**Ativa usuÃ¡rio**

#### 5. **PUT** `/api/usuarios/{id}/inativar`
**Inativa usuÃ¡rio**

#### 6. **POST** `/api/usuarios`
**Cria usuÃ¡rio (admin)**

#### 7. **DELETE** `/api/usuarios/{id}`
**Remove usuÃ¡rio**

### ğŸ¢ Unidades (`/api/unidades`)

#### 1. **GET** `/api/unidades`
**Lista todas as unidades**

#### 2. **GET** `/api/unidades/{id}`
**ObtÃ©m unidade por ID**

#### 3. **POST** `/api/unidades`
**Cria unidade com endereÃ§o**

#### 4. **PUT** `/api/unidades/{id}`
**Atualiza unidade**

#### 5. **DELETE** `/api/unidades/{id}`
**Remove unidade**

### ğŸ¯ FunÃ§Ãµes (`/api/funcoes`)

#### 1. **GET** `/api/funcoes`
**Lista todas as funÃ§Ãµes**

#### 2. **GET** `/api/funcoes/{id}`
**ObtÃ©m funÃ§Ã£o por ID**

#### 3. **POST** `/api/funcoes`
**Cria funÃ§Ã£o**

#### 4. **PUT** `/api/funcoes/{id}`
**Atualiza funÃ§Ã£o**

#### 5. **DELETE** `/api/funcoes/{id}`
**Remove funÃ§Ã£o**

### ğŸ” PermissÃµes (`/api/permissoes`)

#### 1. **GET** `/api/permissoes`
**Lista todas as permissÃµes**

#### 2. **GET** `/api/permissoes/{id}`
**ObtÃ©m permissÃ£o por ID**

#### 3. **POST** `/api/permissoes`
**Cria permissÃ£o**

#### 4. **PUT** `/api/permissoes/{id}`
**Atualiza permissÃ£o**

#### 5. **DELETE** `/api/permissoes/{id}`
**Remove permissÃ£o**

### ğŸ’» Sistemas (`/api/sistemas`)

#### 1. **GET** `/api/sistemas`
**Lista todos os sistemas**

#### 2. **GET** `/api/sistemas/{id}`
**ObtÃ©m sistema por ID**

#### 3. **POST** `/api/sistemas`
**Cria sistema**

#### 4. **PUT** `/api/sistemas/{id}`
**Atualiza sistema**

#### 5. **DELETE** `/api/sistemas/{id}`
**Remove sistema**

### ğŸ”— UsuÃ¡rio-PermissÃ£o-Sistema (`/api/usuariopermissaosistema`)

#### 1. **GET** `/api/usuariopermissaosistema`
**Lista todos os vÃ­nculos**

#### 2. **GET** `/api/usuariopermissaosistema/{id}`
**ObtÃ©m vÃ­nculo por ID**

#### 3. **POST** `/api/usuariopermissaosistema`
**Cria vÃ­nculo usuÃ¡rio-sistema-permissÃ£o**

#### 4. **PUT** `/api/usuariopermissaosistema/{id}`
**Atualiza vÃ­nculo**

#### 5. **DELETE** `/api/usuariopermissaosistema/{id}`
**Remove vÃ­nculo**

#### 6. **GET** `/api/usuariopermissaosistema/verificar-acesso/{sistemaId}`
**Verifica acesso do usuÃ¡rio a um sistema**

**Headers:** `Authorization: Bearer {jwt_token}`

**Response:**
```json
{
  "sucesso": true,
  "dados": {
    "temAcesso": true,
    "permissao": "string",
    "permissaoId": "guid",
    "sistema": {
      "id": "guid",
      "nome": "string",
      "descricao": "string"
    },
    "dataVinculo": "datetime",
    "mensagem": "string"
  }
}
```

#### 7. **GET** `/api/usuariopermissaosistema/meus-sistemas`
**Lista sistemas e permissÃµes do usuÃ¡rio logado**

**Headers:** `Authorization: Bearer {jwt_token}`

**Response:**
```json
{
  "sucesso": true,
  "dados": {
    "totalSistemas": 3,
    "sistemas": [
      {
        "sistema": {
          "id": "guid",
          "nome": "string",
          "descricao": "string"
        },
        "permissao": {
          "id": "guid",
          "nome": "string",
          "descricao": "string"
        },
        "dataVinculo": "datetime"
      }
    ]
  }
}
```

## ğŸ“§ ServiÃ§o de E-mail

### ConfiguraÃ§Ã£o SMTP
```json
{
  "Smtp": {
    "Host": "smtp.gmail.com",
    "Port": 587,
    "Username": "sgm.smsrio@gmail.com",
    "Password": "ixqq uspj rmiz eiep"
  }
}
```

### Templates DisponÃ­veis
- **Acesso Criado**: Credenciais para novos usuÃ¡rios
- **CÃ³digo de AutenticaÃ§Ã£o**: 2FA para login
- **RedefiniÃ§Ã£o de Senha**: CÃ³digo para troca de senha

### Anexos Inline
- Logo da Prefeitura do Rio
- Logo da GestÃ£o

## ğŸ—„ï¸ Modelos de Dados

### Usuario
- ID, Email, SenhaHash, Ativo, EmailConfirmado
- TentativasLogin, BloqueadoAte, UltimoLogin
- TipoUsuario, CriadoEm, AtualizadoEm, DeletedAt
- PrecisaTrocarSenha, SenhaExpiraEm

### UsuarioInfo
- UsuarioId, NomeCompleto, Matricula, Cpf (criptografado)
- Telefone, Sexo, DataNascimento, Vinculo
- UnidadeId, FuncaoId, EnderecoId, AtualizadoEm

### Endereco
- ID, Logradouro, Numero, Complemento, Bairro
- Cidade, Estado, Cep, AtualizadoEm

### Unidade
- ID, Nome, Cap, EnderecoId, AtualizadoEm

### Funcao
- ID, Nome, AtualizadoEm

### Permissao
- ID, Nome, Descricao, AtualizadoEm

### Sistema
- ID, Nome, Descricao, AtualizadoEm

### UsuarioPermissaoSistema
- ID, UsuarioId, SistemaId, PermissaoId
- AtribuidoEm, AtualizadoEm

### RefreshToken
- ID, UsuarioId, Token, Expiracao
- CriadoEm, Utilizado, DoisFatoresConfirmado

### CodigoAutenticacao
- ID, UsuarioId, Codigo (hash), Expiracao
- Utilizado, CriadoEm

## ğŸ”’ Regras de SeguranÃ§a

### ValidaÃ§Ãµes de Entrada
- **CPF**: Algoritmo oficial de validaÃ§Ã£o
- **Telefone**: 10-11 dÃ­gitos numÃ©ricos
- **CEP**: 8 dÃ­gitos numÃ©ricos
- **Data Nascimento**: Entre 13 e 90 anos
- **Sexo**: M, F, O (MASCULINO, FEMININO, OUTRO)

### Controle de Acesso
- VerificaÃ§Ã£o de permissÃ£o por sistema
- ValidaÃ§Ã£o de perfil completo
- Controle de sessÃµes ativas
- Logout seguro com invalidaÃ§Ã£o de tokens

### ProteÃ§Ã£o de Dados
- Senhas nunca armazenadas em texto plano
- CPF criptografado com AES-256
- Tokens JWT com expiraÃ§Ã£o controlada
- Refresh tokens com rotaÃ§Ã£o automÃ¡tica

## ğŸš¦ Status Codes

- **200**: Sucesso
- **201**: Criado
- **400**: Dados invÃ¡lidos
- **401**: NÃ£o autorizado
- **403**: Proibido
- **404**: NÃ£o encontrado
- **409**: Conflito
- **500**: Erro interno

## ğŸ”§ ConfiguraÃ§Ã£o

### VariÃ¡veis de Ambiente
```json
{
  "ConnectionStrings": {
    "DefaultConnection": "Host=10.1.72.166;Port=5432;Database=usuarios;Username=SUBG-HOM;Password=$ubg@2@25"
  },
  "Jwt": {
    "Key": "chave-secreta-256-bits",
    "Issuer": "your_issuer",
    "Audience": "your_audience"
  },
  "Crypto": {
    "Key": "A1b2C3d4E5f6G7h8",
    "IV": "Z9y8X7w6V5u4T3s2"
  }
}
```

### CORS
```csharp
options.AddPolicy("FrontendPolicy", policy =>
{
    policy.WithOrigins("http://localhost:3000", "http://localhost:5173", "http://localhost:3001")
          .AllowAnyHeader()
          .AllowAnyMethod()
          .AllowCredentials();
});
```

## ğŸ“± Frontend CompatÃ­vel

- **React Vite** com TypeScript
- **React Router DOM** para navegaÃ§Ã£o
- **TailwindCSS** para estilizaÃ§Ã£o
- **Shadcn/UI** para componentes
- **Portas**: 3000, 3001, 5173

## ğŸš€ Deploy e ExecuÃ§Ã£o

### PrÃ©-requisitos
- .NET 9 SDK
- PostgreSQL
- SMTP configurado

### ExecuÃ§Ã£o
```bash
cd Micro-Auth
dotnet restore
dotnet build
dotnet run
```

### Swagger
- **URL**: `/swagger` (apenas em desenvolvimento)
- **DocumentaÃ§Ã£o**: AutomÃ¡tica da API

## ğŸ” Endpoints de Debug (Remover em ProduÃ§Ã£o)

- `POST /api/auth/debug-token`
- `GET /api/auth/listar-tokens-ativos`

## ğŸ“ Notas Importantes

1. **Sempre use HTTPS em produÃ§Ã£o**
2. **Configure chaves JWT seguras**
3. **Monitore tentativas de login**
4. **Implemente rate limiting**
5. **FaÃ§a backup regular do banco**
6. **Mantenha dependÃªncias atualizadas**
7. **Use variÃ¡veis de ambiente para configuraÃ§Ãµes sensÃ­veis**

## ğŸ¤ ContribuiÃ§Ã£o

Este sistema foi desenvolvido para o ambiente da Prefeitura do Rio de Janeiro, com foco em seguranÃ§a e usabilidade. Para contribuiÃ§Ãµes ou dÃºvidas, entre em contato com a equipe de desenvolvimento.

---

**VersÃ£o**: 1.0.0  
**Ãšltima AtualizaÃ§Ã£o**: Dezembro 2024  
**Desenvolvido por**: Equipe de Desenvolvimento - Prefeitura do Rio de Janeiro
