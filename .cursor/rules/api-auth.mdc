# ğŸ“š DocumentaÃ§Ã£o Completa - API de AutenticaÃ§Ã£o

## ğŸ“‹ Ãndice

1. [VisÃ£o Geral](#visÃ£o-geral)
2. [Arquitetura](#arquitetura)
3. [Fluxo de AutenticaÃ§Ã£o Multi-Sistema](#fluxo-de-autenticaÃ§Ã£o-multi-sistema)
4. [Endpoints](#endpoints)
5. [Modelos de Dados (DTOs)](#modelos-de-dados-dtos)
6. [Estrutura do Banco de Dados](#estrutura-do-banco-de-dados)
7. [SeguranÃ§a](#seguranÃ§a)
8. [Exemplos PrÃ¡ticos](#exemplos-prÃ¡ticos)
9. [ConfiguraÃ§Ã£o](#configuraÃ§Ã£o)

---

## ğŸ¯ VisÃ£o Geral

API de autenticaÃ§Ã£o centralizada desenvolvida em **.NET 9.0** para gerenciar autenticaÃ§Ã£o e autorizaÃ§Ã£o de mÃºltiplos sistemas (microsserviÃ§os).

### CaracterÃ­sticas Principais

- âœ… **AutenticaÃ§Ã£o Multi-Sistema**: Um usuÃ¡rio pode ter permissÃµes diferentes em sistemas diferentes
- âœ… **AutenticaÃ§Ã£o 2FA (Two-Factor Authentication)**: CÃ³digo de 6 dÃ­gitos enviado por e-mail
- âœ… **JWT (JSON Web Tokens)**: Tokens com 15 minutos de validade
- âœ… **Refresh Tokens**: Tokens de renovaÃ§Ã£o com 30 dias de validade
- âœ… **RBAC (Role-Based Access Control)**: Controle de permissÃµes granular por sistema
- âœ… **IntegraÃ§Ã£o com MicroserviÃ§o de FuncionÃ¡rios**: ValidaÃ§Ã£o de CPF e status ativo
- âœ… **Criptografia de Dados SensÃ­veis**: CPF criptografado com AES-256
- âœ… **Gerenciamento de SessÃµes**: Logout individual ou de todas as sessÃµes
- âœ… **Cache em MemÃ³ria**: Cache de permissÃµes com TTL de 15 minutos
- âœ… **Retry Policy com Polly**: ResiliÃªncia em chamadas HTTP externas
- âœ… **Ãndices de Banco Otimizados**: Performance otimizada para consultas frequentes
- âœ… **Middlewares de SeguranÃ§a**: Exception Handler e Security Headers

### Tecnologias

- **.NET 9.0**
- **ASP.NET Core Web API**
- **Entity Framework Core** (ORM)
- **PostgreSQL** (Banco de dados)
- **JWT Bearer Authentication**
- **BCrypt** (Hash de senhas)
- **AES-256** (Criptografia de CPF)
- **IMemoryCache** (Cache em memÃ³ria)
- **Polly** (Retry policy e resiliÃªncia)
- **Hangfire** (Background jobs)

---

## ğŸ—ï¸ Arquitetura

### Estrutura do Projeto

```
auth-api/
â”œâ”€â”€ Controllers/          # Endpoints da API
â”‚   â””â”€â”€ AuthController.cs
â”œâ”€â”€ Services/            # LÃ³gica de negÃ³cio
â”‚   â”œâ”€â”€ Auth/
â”‚   â”‚   â”œâ”€â”€ AuthService.cs
â”‚   â”‚   â”œâ”€â”€ TokenService.cs
â”‚   â”‚   â””â”€â”€ ITokenService.cs
â”‚   â”œâ”€â”€ FuncionarioService.cs
â”‚   â””â”€â”€ EmailService.cs
â”œâ”€â”€ Repositories/        # Acesso a dados (Repository Pattern)
â”‚   â”œâ”€â”€ UsuarioRepository.cs
â”‚   â”œâ”€â”€ RefreshTokenRepository.cs
â”‚   â””â”€â”€ UnitOfWork.cs
â”œâ”€â”€ Models/             # Entidades do banco de dados
â”‚   â”œâ”€â”€ Usuario.cs
â”‚   â”œâ”€â”€ Sistema.cs
â”‚   â”œâ”€â”€ Permissao.cs
â”‚   â””â”€â”€ UsuarioPermissaoSistema.cs
â”œâ”€â”€ Dtos/              # Data Transfer Objects
â”‚   â”œâ”€â”€ Cadastro/
â”‚   â”œâ”€â”€ Usuario/
â”‚   â””â”€â”€ Sistema/
â”œâ”€â”€ Helpers/           # FunÃ§Ãµes auxiliares
â”‚   â”œâ”€â”€ JwtHelper.cs
â”‚   â”œâ”€â”€ CryptoHelper.cs
â”‚   â”œâ”€â”€ HashHelper.cs
â”‚   â””â”€â”€ ValidationHelper.cs
â”œâ”€â”€ Data/             # Contexto EF Core
â”‚   â””â”€â”€ AppDbContext.cs
â””â”€â”€ Utils/            # UtilitÃ¡rios
    â””â”€â”€ Result.cs
```

### PadrÃµes de Projeto

- **Repository Pattern**: AbstraÃ§Ã£o do acesso a dados
- **Unit of Work**: Gerenciamento de transaÃ§Ãµes
- **Dependency Injection**: InversÃ£o de controle
- **Service Layer**: SeparaÃ§Ã£o da lÃ³gica de negÃ³cio
- **DTO Pattern**: TransferÃªncia de dados entre camadas

---

## ğŸ”„ Fluxo de AutenticaÃ§Ã£o Multi-Sistema

### Conceito de Multi-Sistema

A API gerencia autenticaÃ§Ã£o para **mÃºltiplos sistemas/microsserviÃ§os**. Cada usuÃ¡rio pode ter:
- Acesso a um ou mais sistemas
- PermissÃµes diferentes em cada sistema
- Tokens JWT especÃ­ficos para cada sistema

### Fluxo Completo

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   Cliente   â”‚
â”‚  (Frontend) â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â”‚ 1. POST /api/auth/login
       â”‚    { email, senha, sistemaId }
       â”‚
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              API de AutenticaÃ§Ã£o                â”‚
â”‚                                                 â”‚
â”‚  2. Valida credenciais                         â”‚
â”‚  3. Valida se usuÃ¡rio tem acesso ao sistema    â”‚
â”‚  4. Consulta API de FuncionÃ¡rios (CPF ativo?)  â”‚
â”‚  5. Gera cÃ³digo 2FA (6 dÃ­gitos)                â”‚
â”‚  6. Envia cÃ³digo por e-mail                    â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â”‚ 7. Retorna: "CÃ³digo enviado por e-mail"
       â”‚
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   Cliente   â”‚
â”‚  (Frontend) â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â”‚ 8. POST /api/auth/confirmar-codigo-2fa
       â”‚    { email, codigo, sistemaId }
       â”‚
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              API de AutenticaÃ§Ã£o                â”‚
â”‚                                                 â”‚
â”‚  9. Valida cÃ³digo 2FA                          â”‚
â”‚  10. Gera JWT com permissÃµes do sistema        â”‚
â”‚      - Filtra APENAS permissÃµes do sistemaId   â”‚
â”‚      - Token vÃ¡lido por 15 minutos             â”‚
â”‚  11. Gera Refresh Token (30 dias)              â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â”‚ 12. Retorna: { token, refreshToken, usuario }
       â”‚
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   Cliente   â”‚
â”‚  usa token  â”‚
â”‚  JWT para   â”‚
â”‚  requisiÃ§Ãµesâ”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Estrutura do Token JWT

O token contÃ©m **apenas** as permissÃµes do sistema especÃ­fico:

```json
{
  "sub": "usuario@exemplo.com",
  "usuarioId": "uuid-do-usuario",
  "nomeCompleto": "Nome do UsuÃ¡rio",
  "cpf": "12345678901",
  "sistemaId": "uuid-do-sistema",
  "sistemaNome": "Sistema RH",
  "permissao": ["1", "2", "3"],
  "permissaoNome": ["Visualizar", "Criar", "Editar"],
  "exp": 1234567890
}
```

---

## ğŸ”Œ Endpoints

### Base URL

```
http://localhost:5000/api/auth
```

---

### 1. **POST** `/register`

Registra um novo usuÃ¡rio no sistema. **Suporta fluxo de 2 etapas**: verifica se usuÃ¡rio jÃ¡ existe e retorna dados para prÃ©-preenchimento de permissÃµes.

#### ğŸ“¥ Request Body

```json
{
  "email": "usuario@exemplo.com",
  "nomeCompleto": "JoÃ£o Silva",
  "cpf": "12345678901",
  "senhaExpiraEm": "2025-12-31"
}
```

#### ValidaÃ§Ãµes

- âœ… E-mail deve ser vÃ¡lido
- âœ… CPF deve existir na base de funcionÃ¡rios
- âœ… FuncionÃ¡rio deve estar ativo
- âœ… CPF e e-mail devem ser Ãºnicos
- âœ… Nome completo: 3-100 caracteres

#### ğŸ“¤ Response (200 OK) - Novo UsuÃ¡rio Criado

```json
{
  "sucesso": true,
  "mensagem": "UsuÃ¡rio cadastrado com sucesso. Senha provisÃ³ria enviada por e-mail.",
  "dados": {
    "usuarioId": "uuid-gerado"
  }
}
```

#### ğŸ“¤ Response (409 Conflict) - UsuÃ¡rio JÃ¡ Existe

Quando o CPF jÃ¡ estÃ¡ cadastrado, retorna dados completos do usuÃ¡rio e permissÃµes existentes:

```json
{
  "sucesso": false,
  "mensagem": "UsuÃ¡rio jÃ¡ cadastrado com este CPF.",
  "dados": {
    "existe": true,
    "usuario": {
      "id": "uuid-do-usuario-existente",
      "email": "usuario@exemplo.com",
      "nomeCompleto": "JoÃ£o Silva",
      "ativo": true,
      "emailConfirmado": true,
      "criadoEm": "2025-01-01T10:00:00Z"
    },
    "permissoes": [
      {
        "sistemaId": "uuid-sistema-rh",
        "sistemaNome": "Sistema RH",
        "permissoes": [
          { "id": 1, "nome": "Visualizar" },
          { "id": 2, "nome": "Criar" }
        ]
      }
    ]
  }
}
```

**ğŸ’¡ Uso no Frontend**: Utilize os dados retornados para prÃ©-preencher o formulÃ¡rio de permissÃµes na etapa 2 do cadastro.

#### ğŸ“¤ Response (400 Bad Request)

```json
{
  "sucesso": false,
  "mensagem": "CPF nÃ£o encontrado na base de funcionÃ¡rios. Apenas funcionÃ¡rios cadastrados podem ter acesso ao sistema.",
  "dados": null
}
```

#### ğŸ“§ E-mail Enviado

O sistema gera uma **senha forte aleatÃ³ria** e envia por e-mail. O usuÃ¡rio deverÃ¡ trocar a senha no primeiro login.

---

### 2. **POST** `/login`

Realiza login e envia cÃ³digo 2FA por e-mail.

#### ğŸ“¥ Request Body

```json
{
  "email": "usuario@exemplo.com",
  "senha": "SenhaForte123!",
  "sistemaId": "a1b2c3d4-e5f6-7890-abcd-ef1234567890"
}
```

#### âš ï¸ Campo ObrigatÃ³rio: `sistemaId`

O `sistemaId` identifica qual sistema o usuÃ¡rio estÃ¡ tentando acessar. **ObrigatÃ³rio** para:
- Validar se usuÃ¡rio tem permissÃ£o no sistema
- Filtrar permissÃµes no JWT gerado

#### ValidaÃ§Ãµes Realizadas

1. âœ… Credenciais (e-mail e senha)
2. âœ… UsuÃ¡rio ativo
3. âœ… FuncionÃ¡rio ainda ativo (consulta API externa)
4. âœ… Perfil completo (nome, CPF preenchidos)
5. âœ… UsuÃ¡rio tem acesso ao sistema especificado

#### ğŸ“¤ Response (200 OK)

```json
{
  "sucesso": true,
  "mensagem": "CÃ³digo de autenticaÃ§Ã£o enviado para o e-mail. Informe o cÃ³digo para prosseguir com o login.",
  "dados": null
}
```

#### ğŸ“¤ Response (401 Unauthorized)

```json
{
  "sucesso": false,
  "mensagem": "VocÃª nÃ£o tem permissÃ£o para acessar este sistema. Entre em contato com o administrador.",
  "dados": null
}
```

#### ğŸ“§ CÃ³digo 2FA

- CÃ³digo de **6 dÃ­gitos** numÃ©ricos
- VÃ¡lido por **5 minutos**
- Hash armazenado no banco (SHA-256)

---

### 3. **POST** `/confirmar-codigo-2fa`

Confirma cÃ³digo 2FA e retorna tokens de autenticaÃ§Ã£o.

#### ğŸ“¥ Request Body

```json
{
  "email": "usuario@exemplo.com",
  "codigo": "123456",
  "sistemaId": "a1b2c3d4-e5f6-7890-abcd-ef1234567890"
}
```

#### âš ï¸ Importante

O `sistemaId` deve ser o **mesmo** enviado no `/login`.

#### ğŸ“¤ Response (200 OK) - Login Normal

```json
{
  "sucesso": true,
  "mensagem": "Login realizado com sucesso.",
  "dados": {
    "token": "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...",
    "refreshToken": "base64-encoded-refresh-token",
    "usuario": {
      "id": "uuid-do-usuario",
      "email": "usuario@exemplo.com",
      "nomeCompleto": "JoÃ£o Silva",
      "precisaTrocarSenha": false,
      "sistemaId": "uuid-do-sistema"
    }
  }
}
```

#### ğŸ“¤ Response (200 OK) - Senha Expirada

```json
{
  "sucesso": true,
  "mensagem": "Senha expirada detectada. ConfirmaÃ§Ã£o de cÃ³digo realizada. Prossiga com a redefiniÃ§Ã£o da senha.",
  "dados": {
    "senhaExpirada": true,
    "tokenTrocaSenha": "token-temporario-10min",
    "usuario": {
      "id": "uuid-do-usuario",
      "email": "usuario@exemplo.com",
      "nomeCompleto": "JoÃ£o Silva"
    }
  }
}
```

#### ğŸ“¤ Response (200 OK) - Precisa Trocar Senha

```json
{
  "sucesso": true,
  "mensagem": "Troca de senha obrigatÃ³ria. Informe a nova senha para prosseguir.",
  "dados": {
    "precisaTrocarSenha": true,
    "tokenTrocaSenha": "token-temporario-10min"
  }
}
```

#### ğŸ“¤ Response (400 Bad Request)

```json
{
  "sucesso": false,
  "mensagem": "CÃ³digo invÃ¡lido ou jÃ¡ utilizado.",
  "dados": null
}
```

---

### 4. **POST** `/trocar-senha`

Altera a senha do usuÃ¡rio.

#### ğŸ“¥ Request Body (Com Token)

```json
{
  "email": "usuario@exemplo.com",
  "novaSenha": "NovaSenhaForte123!",
  "tokenTrocaSenha": "token-temporario-recebido"
}
```

#### ValidaÃ§Ãµes

- âœ… Nova senha: mÃ­nimo 8 caracteres
- âœ… Nova senha diferente da anterior
- âœ… Token de troca vÃ¡lido (10 minutos)

#### ğŸ“¤ Response (200 OK)

```json
{
  "sucesso": true,
  "mensagem": "Senha alterada com sucesso. VocÃª jÃ¡ pode acessar o sistema.",
  "dados": {
    "token": "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...",
    "refreshToken": "base64-encoded-refresh-token",
    "usuario": {
      "id": "uuid-do-usuario",
      "email": "usuario@exemplo.com",
      "nomeCompleto": "",
      "precisaTrocarSenha": false
    }
  }
}
```

---

### 5. **POST** `/esqueci-senha`

Inicia processo de recuperaÃ§Ã£o de senha.

#### ğŸ“¥ Request Body

```json
{
  "email": "usuario@exemplo.com"
}
```

#### ğŸ“¤ Response (200 OK)

```json
{
  "sucesso": true,
  "mensagem": "Se o e-mail informado estiver cadastrado, um cÃ³digo de autenticaÃ§Ã£o foi enviado para ele.",
  "dados": null
}
```

#### Comportamento

1. Verifica se e-mail existe (sem revelar ao cliente)
2. Gera cÃ³digo 2FA de 6 dÃ­gitos
3. Marca `precisaTrocarSenha = true`
4. Envia cÃ³digo por e-mail
5. **Sempre** retorna mensagem de sucesso (seguranÃ§a)

#### Fluxo Completo

```
1. POST /esqueci-senha â†’ CÃ³digo enviado
2. POST /confirmar-codigo-2fa â†’ Retorna tokenTrocaSenha
3. POST /trocar-senha â†’ Altera senha e retorna JWT
```

---

### 6. **POST** `/refresh-token`

Renova o access token usando refresh token.

#### ğŸ“¥ Request Body

```json
{
  "refreshToken": "base64-encoded-refresh-token"
}
```

#### ValidaÃ§Ãµes

- âœ… Refresh token vÃ¡lido
- âœ… Refresh token nÃ£o expirado (30 dias)
- âœ… Refresh token nÃ£o utilizado
- âœ… 2FA foi confirmado
- âœ… UsuÃ¡rio ativo

#### ğŸ“¤ Response (200 OK)

```json
{
  "sucesso": true,
  "mensagem": "Token renovado com sucesso.",
  "dados": {
    "token": "novo-jwt-token",
    "refreshToken": "novo-refresh-token",
    "expiresIn": 7200,
    "refreshTokenExpiresIn": 2678400,
    "usuario": {
      "id": "uuid-do-usuario",
      "email": "usuario@exemplo.com",
      "nomeCompleto": "JoÃ£o Silva",
      "emailConfirmado": true,
      "ativo": true
    }
  }
}
```

#### âš ï¸ ObservaÃ§Ã£o

O refresh token **antigo Ã© invalidado** ao gerar um novo. Isso previne reutilizaÃ§Ã£o.

---

### 7. **POST** `/logout`

Realiza logout invalidando o refresh token atual.

#### ğŸ“¥ Request Body

```json
{
  "refreshToken": "base64-encoded-refresh-token"
}
```

#### ğŸ“¤ Response (200 OK)

```json
{
  "sucesso": true,
  "mensagem": "Logout realizado com sucesso.",
  "dados": null
}
```

---

### 8. **POST** `/logout-all-sessions`

Realiza logout de **todas as sessÃµes ativas** do usuÃ¡rio.

#### ğŸ“¥ Request Body

```json
{
  "refreshToken": "base64-encoded-refresh-token"
}
```

#### ğŸ“¤ Response (200 OK)

```json
{
  "sucesso": true,
  "mensagem": "Logout de todas as sessÃµes realizado com sucesso.",
  "dados": null
}
```

#### Comportamento

Invalida todos os refresh tokens do usuÃ¡rio, forÃ§ando re-login em todos os dispositivos.

---

### 9. **POST** `/sessoes-ativas`

ObtÃ©m todas as sessÃµes ativas do usuÃ¡rio.

#### ğŸ“¥ Request Body

```json
{
  "refreshToken": "base64-encoded-refresh-token"
}
```

#### ğŸ“¤ Response (200 OK)

```json
{
  "sucesso": true,
  "mensagem": "SessÃµes ativas obtidas com sucesso.",
  "dados": {
    "quantidadeSessoes": 3,
    "sessoes": [
      {
        "id": "uuid-sessao-1",
        "criadoEm": "2025-11-12T10:00:00Z",
        "expiracao": "2025-12-12T10:00:00Z",
        "doisFatoresConfirmado": true,
        "ehSessaoAtual": true
      },
      {
        "id": "uuid-sessao-2",
        "criadoEm": "2025-11-10T15:30:00Z",
        "expiracao": "2025-12-10T15:30:00Z",
        "doisFatoresConfirmado": true,
        "ehSessaoAtual": false
      }
    ]
  }
}
```

---

### 10. **GET** `/validar-permissao`

Valida se o usuÃ¡rio autenticado tem uma permissÃ£o especÃ­fica em um sistema.

#### ğŸ” AutenticaÃ§Ã£o

**Requer JWT no header:**

```
Authorization: Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...
```

#### ğŸ“¥ Query Parameters

```
GET /api/auth/validar-permissao?sistemaId=uuid-sistema&permissaoNome=Criar
```

| ParÃ¢metro | Tipo | DescriÃ§Ã£o |
|-----------|------|-----------|
| sistemaId | Guid | ID do sistema |
| permissaoNome | string | Nome da permissÃ£o (ex: "Visualizar", "Criar", "Editar") |

#### ğŸ“¤ Response (200 OK) - Tem PermissÃ£o

```json
{
  "sucesso": true,
  "mensagem": "UsuÃ¡rio tem a permissÃ£o.",
  "dados": true
}
```

#### ğŸ“¤ Response (200 OK) - NÃ£o Tem PermissÃ£o

```json
{
  "sucesso": true,
  "mensagem": "UsuÃ¡rio nÃ£o tem a permissÃ£o.",
  "dados": false
}
```

#### ğŸ“¤ Response (403 Forbidden)

Retornado quando o token JWT Ã© de um sistema diferente do solicitado.

#### ğŸ’¡ Uso pelos MicrosserviÃ§os

```csharp
// MicrosserviÃ§o validando permissÃ£o do usuÃ¡rio
var client = new HttpClient();
client.DefaultRequestHeaders.Authorization =
    new AuthenticationHeaderValue("Bearer", tokenDoUsuario);

var response = await client.GetAsync(
    $"http://auth-api/api/auth/validar-permissao?sistemaId={sistemaId}&permissaoNome=Criar"
);

var resultado = await response.Content.ReadFromJsonAsync<Result<bool>>();
if (resultado.Dados)
{
    // UsuÃ¡rio tem permissÃ£o
}
```

---

### 11. **GET** `/minhas-permissoes`

Retorna todas as permissÃµes do usuÃ¡rio autenticado em um sistema especÃ­fico.

#### ğŸ” AutenticaÃ§Ã£o

**Requer JWT no header:**

```
Authorization: Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...
```

#### ğŸ“¥ Query Parameters

```
GET /api/auth/minhas-permissoes?sistemaId=uuid-sistema
```

#### ğŸ“¤ Response (200 OK)

```json
{
  "sucesso": true,
  "mensagem": null,
  "dados": {
    "sistemaId": "uuid-do-sistema",
    "sistemaNome": "Sistema RH",
    "permissoes": [
      "Visualizar",
      "Criar",
      "Editar",
      "Deletar"
    ],
    "permissoesIds": [1, 2, 3, 4]
  }
}
```

---

### 12. **POST** `/sincronizar-funcionario`

Sincroniza dados do funcionÃ¡rio com o sistema de autenticaÃ§Ã£o (busca na API externa).

#### ğŸ“¥ Request Body

```json
"12345678901"
```

*Nota: Envia CPF como string direta (sem JSON)*

#### ğŸ“¤ Response (200 OK)

```json
{
  "sucesso": true,
  "mensagem": "Dados do funcionÃ¡rio sincronizados com sucesso.",
  "dados": null
}
```

---

### 13. **GET** `/verificar-usuario-por-cpf/{cpf}`

Verifica se um usuÃ¡rio jÃ¡ existe no sistema atravÃ©s do CPF. Retorna dados completos do usuÃ¡rio e permissÃµes se existir.

**âš¡ OtimizaÃ§Ã£o**: Utiliza cache em memÃ³ria com TTL de 15 minutos para consultas de permissÃµes.

#### ğŸ“¥ Request

```bash
GET /api/auth/verificar-usuario-por-cpf/12345678901
```

#### ğŸ“¤ Response (200 OK) - UsuÃ¡rio Existe

```json
{
  "sucesso": true,
  "mensagem": null,
  "dados": {
    "existe": true,
    "usuario": {
      "id": "uuid-do-usuario",
      "email": "usuario@exemplo.com",
      "nomeCompleto": "JoÃ£o Silva",
      "ativo": true,
      "emailConfirmado": true,
      "criadoEm": "2025-01-15T10:00:00Z"
    },
    "permissoes": [
      {
        "sistemaId": "uuid-sistema-rh",
        "sistemaNome": "Sistema RH",
        "permissoes": [
          { "id": 1, "nome": "Visualizar" },
          { "id": 2, "nome": "Criar" }
        ]
      },
      {
        "sistemaId": "uuid-sistema-fin",
        "sistemaNome": "Sistema Financeiro",
        "permissoes": [
          { "id": 1, "nome": "Visualizar" }
        ]
      }
    ]
  }
}
```

#### ğŸ“¤ Response (200 OK) - UsuÃ¡rio NÃ£o Existe

```json
{
  "sucesso": true,
  "mensagem": "UsuÃ¡rio nÃ£o encontrado.",
  "dados": {
    "existe": false,
    "usuario": null,
    "permissoes": null
  }
}
```

#### ğŸ“¤ Response (400 Bad Request)

```json
{
  "sucesso": false,
  "mensagem": "CPF invÃ¡lido. Deve conter 11 dÃ­gitos.",
  "dados": null
}
```

#### ğŸ’¡ Uso no Frontend (Fluxo de 2 Etapas)

```javascript
// Etapa 1: Buscar funcionÃ¡rio na API externa e verificar se jÃ¡ Ã© usuÃ¡rio
const cpf = "12345678901";

// 1.1: Buscar dados do funcionÃ¡rio (API externa)
const funcionarioResponse = await fetch(`http://api-funcionarios/api/funcionarios/cpf/${cpf}`);
const funcionario = await funcionarioResponse.json();

// 1.2: Verificar se jÃ¡ Ã© usuÃ¡rio (API de Auth)
const usuarioResponse = await fetch(`http://auth-api/api/auth/verificar-usuario-por-cpf/${cpf}`);
const usuario = await usuarioResponse.json();

if (usuario.dados.existe) {
  // UsuÃ¡rio jÃ¡ existe - prÃ©-preencher formulÃ¡rio com permissÃµes existentes
  preencherFormulario(funcionario, usuario.dados.permissoes);
} else {
  // Novo usuÃ¡rio - prÃ©-preencher apenas dados do funcionÃ¡rio
  preencherFormulario(funcionario, []);
}

// Etapa 2: Atribuir/atualizar permissÃµes (ver endpoint 14)
```

---

### 14. **PUT** `/api/usuarios/{usuarioId}/permissoes`

Atualiza as permissÃµes de um usuÃ¡rio. Remove todas as permissÃµes antigas e adiciona as novas.

**âš¡ OtimizaÃ§Ã£o**: Invalida automaticamente o cache de permissÃµes do usuÃ¡rio apÃ³s atualizaÃ§Ã£o.

#### ğŸ“¥ Request Body

```json
{
  "permissoes": [
    {
      "sistemaId": "uuid-sistema-rh",
      "permissaoId": 1
    },
    {
      "sistemaId": "uuid-sistema-rh",
      "permissaoId": 2
    },
    {
      "sistemaId": "uuid-sistema-fin",
      "permissaoId": 1
    }
  ]
}
```

#### ValidaÃ§Ãµes

- âœ… UsuÃ¡rio deve existir
- âœ… UsuÃ¡rio deve estar ativo
- âœ… Deve haver pelo menos uma permissÃ£o
- âœ… `sistemaId` deve ser GUID vÃ¡lido
- âœ… `permissaoId` deve ser maior que zero

#### ğŸ“¤ Response (200 OK)

```json
{
  "sucesso": true,
  "mensagem": "PermissÃµes atualizadas com sucesso.",
  "dados": {
    "usuarioId": "uuid-do-usuario",
    "quantidadePermissoes": 3,
    "permissoes": [
      {
        "sistemaId": "uuid-sistema-rh",
        "sistemaNome": "Sistema RH",
        "permissoes": [
          { "id": 1, "nome": "Visualizar" },
          { "id": 2, "nome": "Criar" }
        ]
      },
      {
        "sistemaId": "uuid-sistema-fin",
        "sistemaNome": "Sistema Financeiro",
        "permissoes": [
          { "id": 1, "nome": "Visualizar" }
        ]
      }
    ]
  }
}
```

#### ğŸ“¤ Response (404 Not Found)

```json
{
  "sucesso": false,
  "mensagem": "UsuÃ¡rio nÃ£o encontrado.",
  "dados": null
}
```

#### ğŸ“¤ Response (400 Bad Request)

```json
{
  "sucesso": false,
  "mensagem": "NÃ£o Ã© possÃ­vel atualizar permissÃµes de usuÃ¡rio inativo.",
  "dados": null
}
```

#### ğŸ’¡ Uso Completo do Fluxo de 2 Etapas

```javascript
// ETAPA 1: Registro/VerificaÃ§Ã£o
const registroResponse = await fetch('http://auth-api/api/auth/register', {
  method: 'POST',
  headers: { 'Content-Type': 'application/json' },
  body: JSON.stringify({
    email: 'usuario@exemplo.com',
    nomeCompleto: 'JoÃ£o Silva',
    cpf: '12345678901',
    senhaExpiraEm: '2025-12-31'
  })
});

const registroData = await registroResponse.json();

let usuarioId;
if (registroResponse.status === 409) {
  // UsuÃ¡rio jÃ¡ existe - pegar ID e permissÃµes existentes
  usuarioId = registroData.dados.usuario.id;
  const permissoesExistentes = registroData.dados.permissoes;
  // Exibir formulÃ¡rio prÃ©-preenchido
} else if (registroResponse.status === 200) {
  // Novo usuÃ¡rio criado
  usuarioId = registroData.dados.usuarioId;
  // Exibir formulÃ¡rio vazio de permissÃµes
}

// ETAPA 2: Atualizar PermissÃµes
const permissoesResponse = await fetch(
  `http://auth-api/api/usuarios/${usuarioId}/permissoes`,
  {
    method: 'PUT',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({
      permissoes: [
        { sistemaId: 'uuid-rh', permissaoId: 1 },
        { sistemaId: 'uuid-rh', permissaoId: 2 }
      ]
    })
  }
);

const permissoesData = await permissoesResponse.json();
console.log('PermissÃµes atualizadas:', permissoesData.dados);
```

---

## ğŸ›¡ï¸ Perfis de PermissÃ£o DisponÃ­veis

Os microsserviÃ§os utilizam os perfis abaixo para controlar o acesso granular nos sistemas. Cada perfil possui um identificador Ãºnico (`permissaoId`) que deve ser enviado ao atribuir permissÃµes via `PUT /api/usuarios/{usuarioId}/permissoes`.

| ID | Nome         | DescriÃ§Ã£o                              |
|----|--------------|----------------------------------------|
| 1  | Supervisor   | Administrador do sistema.              |
| 2  | Analista I   | UsuÃ¡rio com permissÃµes especiais.      |
| 3  | Analista II  | Perfil comum com acesso limitado.      |
| 4  | Visualizador | Perfil visualizador do sistema.        |
| 5  | Desenvolvedor| Desenvolvedor das aplicaÃ§Ãµes web.      |

> ğŸ’¡ Utilize sempre o `ID` da permissÃ£o ao montar o payload de atualizaÃ§Ã£o de permissÃµes do usuÃ¡rio. O campo `nome` Ã© exibido apenas para referÃªncia humana.

## ğŸ“¦ Modelos de Dados (DTOs)

### DtoUsuarioRegister

```csharp
{
  "email": "string (obrigatÃ³rio, max 100)",
  "nomeCompleto": "string (obrigatÃ³rio, 3-100 caracteres)",
  "cpf": "string (obrigatÃ³rio, 11-14 caracteres)",
  "senhaExpiraEm": "DateOnly (obrigatÃ³rio)"
}
```

### LoginDto

```csharp
{
  "email": "string (obrigatÃ³rio, email vÃ¡lido)",
  "senha": "string (obrigatÃ³rio)",
  "sistemaId": "Guid (obrigatÃ³rio)"
}
```

### DtoConfirmarEmail

```csharp
{
  "email": "string (obrigatÃ³rio, email vÃ¡lido)",
  "codigo": "string (obrigatÃ³rio, 6 dÃ­gitos)",
  "sistemaId": "Guid (obrigatÃ³rio)"
}
```

### DtoTrocarSenha

```csharp
{
  "email": "string (obrigatÃ³rio, email vÃ¡lido)",
  "novaSenha": "string (obrigatÃ³rio, min 8 caracteres)",
  "tokenTrocaSenha": "string (opcional)"
}
```

### DtoEsqueciSenha

```csharp
{
  "email": "string (obrigatÃ³rio, email vÃ¡lido)"
}
```

### DtoRefreshTokenRequest

```csharp
{
  "refreshToken": "string (obrigatÃ³rio)"
}
```

### DtoRefreshTokenResponse

```csharp
{
  "token": "string",
  "refreshToken": "string",
  "expiresIn": "int (segundos)",
  "refreshTokenExpiresIn": "int (segundos)",
  "usuario": {
    "id": "Guid",
    "email": "string",
    "nomeCompleto": "string",
    "emailConfirmado": "bool",
    "ativo": "bool"
  }
}
```

### DtoLogoutRequest

```csharp
{
  "refreshToken": "string (obrigatÃ³rio)"
}
```

---

## ğŸ—„ï¸ Estrutura do Banco de Dados

### Tabela: `usuarios`

| Coluna | Tipo | DescriÃ§Ã£o |
|--------|------|-----------|
| id | uuid | PK |
| email | varchar(100) | Ãšnico |
| senha_hash | varchar | Hash BCrypt |
| ativo | boolean | Status do usuÃ¡rio |
| email_confirmado | boolean | E-mail verificado |
| tentativas_login | int | Contador de falhas |
| bloqueado_ate | timestamp | Bloqueio temporÃ¡rio |
| ultimo_login | timestamp | Ãšltimo acesso |
| criado_em | timestamp | Data de criaÃ§Ã£o |
| atualizado_em | timestamp | Ãšltima atualizaÃ§Ã£o |
| deleted_at | timestamp | Soft delete |
| precisa_trocar_senha | boolean | Obriga troca de senha |
| senha_expira_em | timestamp | ExpiraÃ§Ã£o da senha |

### Tabela: `usuarios_info`

| Coluna | Tipo | DescriÃ§Ã£o |
|--------|------|-----------|
| id | uuid | PK |
| usuario_id | uuid | FK â†’ usuarios |
| nome_completo | varchar(100) | Nome do usuÃ¡rio |
| cpf | varchar | CPF criptografado (AES-256) |
| atualizado_em | timestamp | Ãšltima atualizaÃ§Ã£o |

### Tabela: `sistemas`

| Coluna | Tipo | DescriÃ§Ã£o |
|--------|------|-----------|
| id | uuid | PK |
| nome | varchar | Nome do sistema |
| descricao | varchar | DescriÃ§Ã£o opcional |
| atualizado_em | timestamp | Ãšltima atualizaÃ§Ã£o |

### Tabela: `permissoes`

| Coluna | Tipo | DescriÃ§Ã£o |
|--------|------|-----------|
| id | int | PK (enum) |
| nome | varchar | Nome da permissÃ£o |
| descricao | varchar | DescriÃ§Ã£o opcional |
| atualizado_em | timestamp | Ãšltima atualizaÃ§Ã£o |

### Tabela: `usuario_permissao_sistemas`

Tabela de junÃ§Ã£o entre usuÃ¡rios, sistemas e permissÃµes.

| Coluna | Tipo | DescriÃ§Ã£o |
|--------|------|-----------|
| id | uuid | PK |
| usuario_id | uuid | FK â†’ usuarios |
| sistema_id | uuid | FK â†’ sistemas |
| permissao_id | int | FK â†’ permissoes |
| atribuido_em | timestamp | Data de atribuiÃ§Ã£o |
| atualizado_em | timestamp | Ãšltima atualizaÃ§Ã£o |

### Tabela: `refresh_tokens`

| Coluna | Tipo | DescriÃ§Ã£o |
|--------|------|-----------|
| id | uuid | PK |
| usuario_id | uuid | FK â†’ usuarios |
| token | varchar | Token base64 |
| expiracao | timestamp | Validade (30 dias) |
| criado_em | timestamp | Data de criaÃ§Ã£o |
| utilizado | boolean | Se jÃ¡ foi usado |
| dois_fatores_confirmado | boolean | 2FA validado |

### Tabela: `codigos_autenticacao`

| Coluna | Tipo | DescriÃ§Ã£o |
|--------|------|-----------|
| id | uuid | PK |
| usuario_id | uuid | FK â†’ usuarios |
| codigo | varchar | Hash SHA-256 do cÃ³digo |
| expiracao | timestamp | Validade (5 minutos) |
| criado_em | timestamp | Data de criaÃ§Ã£o |
| utilizado | boolean | Se jÃ¡ foi usado |

---

## ğŸ”’ SeguranÃ§a

### AutenticaÃ§Ã£o e AutorizaÃ§Ã£o

1. **JWT (JSON Web Tokens)**
   - Algoritmo: HMAC SHA-256
   - Validade: 15 minutos
   - Claims customizadas com permissÃµes

2. **Refresh Tokens**
   - Armazenados no banco de dados
   - Validade: 30 dias
   - Invalidados apÃ³s uso (rotation)

3. **Two-Factor Authentication (2FA)**
   - CÃ³digo de 6 dÃ­gitos
   - Hash SHA-256 armazenado
   - Validade: 5 minutos
   - Um cÃ³digo por usuÃ¡rio (sobrescreve anteriores)

### ProteÃ§Ã£o de Dados

1. **Hash de Senhas**
   - BCrypt com salt automÃ¡tico
   - Custo de trabalho configurÃ¡vel
   - Resistente a rainbow tables

2. **Criptografia de CPF**
   - AES-256 com IV dinÃ¢mico
   - Chave armazenada em variÃ¡vel de ambiente
   - Suporte a mÃ©todo legado (AES-128)

3. **PrevenÃ§Ã£o de Ataques**
   - Rate limiting (configurÃ¡vel)
   - ProteÃ§Ã£o contra timing attacks
   - ValidaÃ§Ã£o de entrada rigorosa
   - Soft delete (GDPR compliance)

### ValidaÃ§Ãµes de SeguranÃ§a

1. **Durante Registro**
   - CPF deve existir na base de funcionÃ¡rios
   - FuncionÃ¡rio deve estar ativo
   - E-mail e CPF Ãºnicos

2. **Durante Login**
   - ValidaÃ§Ã£o de credenciais
   - VerificaÃ§Ã£o de status ativo (usuÃ¡rio e funcionÃ¡rio)
   - ValidaÃ§Ã£o de acesso ao sistema
   - Perfil deve estar completo

3. **Durante Troca de Senha**
   - Nova senha diferente da anterior
   - MÃ­nimo 8 caracteres
   - Token de troca vÃ¡lido

---

## âš¡ Performance & ResiliÃªncia

### Cache em MemÃ³ria

A API utiliza **IMemoryCache** para otimizar consultas frequentes:

#### PermissÃµes de UsuÃ¡rio
- **Chave**: `permissoes_usuario_{usuarioId}`
- **TTL**: 15 minutos
- **InvalidaÃ§Ã£o**: AutomÃ¡tica ao atualizar permissÃµes via endpoint PUT

**BenefÃ­cios:**
- Reduz carga no banco de dados
- Melhora tempo de resposta em ~70%
- Cache distribuÃ­do por instÃ¢ncia (stateless)

#### Endpoints com Cache
- `GET /verificar-usuario-por-cpf/{cpf}` - Cache de permissÃµes
- Internamente usado em validaÃ§Ãµes de login

### Retry Policy com Polly

Chamadas HTTP para a **API de FuncionÃ¡rios** possuem retry automÃ¡tico:

**ConfiguraÃ§Ã£o:**
- **Tentativas**: 3 retries
- **EstratÃ©gia**: Exponential backoff
  - 1Âª tentativa: 2 segundos
  - 2Âª tentativa: 4 segundos
  - 3Âª tentativa: 8 segundos
- **Erros Tratados**:
  - HTTP 5xx (Server Errors)
  - HTTP 408 (Request Timeout)
  - HttpRequestException (Network Errors)

**BenefÃ­cios:**
- ResiliÃªncia contra falhas transientes
- Melhor disponibilidade do serviÃ§o
- ReduÃ§Ã£o de erros em cenÃ¡rios de rede instÃ¡vel

### Ãndices de Banco de Dados

Ãndices otimizados para consultas frequentes:

| Ãndice | Tabela | Colunas | Tipo | BenefÃ­cio |
|--------|--------|---------|------|-----------|
| IX_usuarios_email | usuarios | email | UNIQUE | Login por email |
| IX_usuarios_info_cpf | usuarios_info | cpf | UNIQUE | VerificaÃ§Ã£o de CPF |
| IX_refresh_tokens_token | refresh_tokens | token | UNIQUE | ValidaÃ§Ã£o de refresh token |
| IX_codigos_autenticacao_usuario_expiracao | codigos_autenticacao | usuario_id, expiracao | COMPOSITE | Busca de cÃ³digos 2FA vÃ¡lidos |
| IX_usuario_permissao_sistema_usuario_sistema | usuario_permissao_sistema | usuario_id, sistema_id | COMPOSITE | VerificaÃ§Ã£o de permissÃµes |

**Performance Gains:**
- Busca por CPF: O(1) ao invÃ©s de O(n)
- ValidaÃ§Ã£o de permissÃµes: ~80% mais rÃ¡pido
- Refresh token lookup: ~90% mais rÃ¡pido

### Middlewares de SeguranÃ§a

#### Exception Handler Middleware
- **FunÃ§Ã£o**: Captura exceÃ§Ãµes nÃ£o tratadas globalmente
- **Desenvolvimento**: Retorna stack trace completo para debug
- **ProduÃ§Ã£o**: Retorna mensagem genÃ©rica sem expor detalhes internos
- **Log**: Todas exceÃ§Ãµes sÃ£o logadas com contexto completo (Path, Method, User, IP)

#### Security Headers Middleware
Adiciona headers de seguranÃ§a em todas as respostas:

```http
X-Content-Type-Options: nosniff
X-Frame-Options: DENY
X-XSS-Protection: 1; mode=block
Content-Security-Policy: default-src 'self'; script-src 'self' 'unsafe-inline'; style-src 'self' 'unsafe-inline';
Referrer-Policy: strict-origin-when-cross-origin
Permissions-Policy: geolocation=(), microphone=(), camera=()
Strict-Transport-Security: max-age=31536000; includeSubDomains (apenas em produÃ§Ã£o)
```

**ProteÃ§Ãµes:**
- âœ… Previne clickjacking (X-Frame-Options)
- âœ… Previne XSS (X-XSS-Protection, CSP)
- âœ… Previne MIME sniffing (X-Content-Type-Options)
- âœ… ForÃ§a HTTPS em produÃ§Ã£o (HSTS)
- âœ… Controla permissÃµes de APIs do browser

---

## ğŸ’¡ Exemplos PrÃ¡ticos

### Exemplo 1: Fluxo de Login Completo (Multi-Sistema)

UsuÃ¡rio **Maria** tem acesso a dois sistemas:
- **Sistema RH** (permissÃµes: Visualizar, Criar)
- **Sistema Financeiro** (permissÃµes: Visualizar, Aprovar)

#### Passo 1: Login no Sistema RH

```bash
POST /api/auth/login
{
  "email": "maria@empresa.com",
  "senha": "SenhaForte123!",
  "sistemaId": "rh-uuid-123"
}
```

**Resposta:**
```json
{
  "sucesso": true,
  "mensagem": "CÃ³digo de autenticaÃ§Ã£o enviado para o e-mail."
}
```

#### Passo 2: Confirmar CÃ³digo 2FA

```bash
POST /api/auth/confirmar-codigo-2fa
{
  "email": "maria@empresa.com",
  "codigo": "485621",
  "sistemaId": "rh-uuid-123"
}
```

**Resposta:**
```json
{
  "sucesso": true,
  "mensagem": "Login realizado com sucesso.",
  "dados": {
    "token": "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...",
    "refreshToken": "abc123...",
    "usuario": {
      "id": "maria-uuid",
      "email": "maria@empresa.com",
      "nomeCompleto": "Maria Silva",
      "precisaTrocarSenha": false,
      "sistemaId": "rh-uuid-123"
    }
  }
}
```

**JWT Decodificado:**
```json
{
  "sub": "maria@empresa.com",
  "usuarioId": "maria-uuid",
  "sistemaId": "rh-uuid-123",
  "sistemaNome": "Sistema RH",
  "permissaoNome": ["Visualizar", "Criar"]
}
```

#### Passo 3: Maria Tenta Acessar Sistema Financeiro

Maria precisa fazer **novo login** para o Sistema Financeiro:

```bash
POST /api/auth/login
{
  "email": "maria@empresa.com",
  "senha": "SenhaForte123!",
  "sistemaId": "financeiro-uuid-456"
}
```

ApÃ³s confirmar o cÃ³digo 2FA, receberÃ¡ um **novo JWT** com permissÃµes diferentes:

```json
{
  "sub": "maria@empresa.com",
  "usuarioId": "maria-uuid",
  "sistemaId": "financeiro-uuid-456",
  "sistemaNome": "Sistema Financeiro",
  "permissaoNome": ["Visualizar", "Aprovar"]
}
```

---

### Exemplo 2: MicrosserviÃ§o Validando PermissÃ£o

**CenÃ¡rio:** MicrosserviÃ§o de RH precisa validar se usuÃ¡rio pode criar funcionÃ¡rios.

```csharp
// No microsserviÃ§o de RH
[HttpPost("criar-funcionario")]
public async Task<IActionResult> CriarFuncionario([FromBody] FuncionarioDto dto)
{
    // Obter sistemaId do token JWT atual
    var sistemaId = User.FindFirst("sistemaId")?.Value;
    var permissoes = User.FindAll("permissaoNome").Select(c => c.Value).ToList();

    // ValidaÃ§Ã£o local (mais rÃ¡pida)
    if (!permissoes.Contains("Criar"))
        return Forbid();

    // OU validaÃ§Ã£o via API (mais segura)
    var client = new HttpClient();
    client.DefaultRequestHeaders.Authorization =
        new AuthenticationHeaderValue("Bearer", HttpContext.Request.Headers["Authorization"]);

    var response = await client.GetAsync(
        $"http://auth-api/api/auth/validar-permissao?sistemaId={sistemaId}&permissaoNome=Criar"
    );

    var resultado = await response.Content.ReadFromJsonAsync<Result<bool>>();
    if (!resultado.Dados)
        return Forbid();

    // Prosseguir com criaÃ§Ã£o do funcionÃ¡rio
    // ...
}
```

---

### Exemplo 3: RecuperaÃ§Ã£o de Senha

```bash
# 1. Solicitar recuperaÃ§Ã£o
POST /api/auth/esqueci-senha
{
  "email": "usuario@empresa.com"
}

# 2. Confirmar cÃ³digo recebido por e-mail
POST /api/auth/confirmar-codigo-2fa
{
  "email": "usuario@empresa.com",
  "codigo": "938471",
  "sistemaId": "qualquer-sistema-uuid"
}

# Resposta: { precisaTrocarSenha: true, tokenTrocaSenha: "token-temp" }

# 3. Definir nova senha
POST /api/auth/trocar-senha
{
  "email": "usuario@empresa.com",
  "novaSenha": "NovaSenhaSegura456!",
  "tokenTrocaSenha": "token-temp-recebido"
}

# Resposta: { token, refreshToken, usuario }
```

---

## âš™ï¸ ConfiguraÃ§Ã£o

### VariÃ¡veis de Ambiente (`.env`)

```env
# Database
DATABASE_URL=Host=localhost;Port=5432;Database=auth_db;Username=postgres;Password=senha

# JWT
JWT_KEY=sua-chave-secreta-super-segura-min-32-caracteres
JWT_ISSUER=MicroAuth
JWT_AUDIENCE=MicroAuthUsers

# Crypto (Criptografia de CPF)
CRYPTO_KEY=chave-aes-128-legada
CRYPTO_IV=iv-aes-128-legado
CRYPTO_NEWKEY=chave-aes-256-nova-com-32-caracteres

# Email
EMAIL_HOST=smtp.gmail.com
EMAIL_PORT=587
EMAIL_USERNAME=seu-email@gmail.com
EMAIL_PASSWORD=sua-senha-app
EMAIL_FROM=noreply@empresa.com

# API Externa - FuncionÃ¡rios
FUNCIONARIO_API_BASE_URL=http://localhost:7000
```

### appsettings.json

```json
{
  "Logging": {
    "LogLevel": {
      "Default": "Information",
      "Microsoft.AspNetCore": "Warning"
    }
  },
  "AllowedHosts": "*",
  "ConnectionStrings": {
    "DefaultConnection": "Host=localhost;Port=5432;Database=auth_db;Username=postgres;Password=senha"
  },
  "Jwt": {
    "Key": "sua-chave-secreta-super-segura-min-32-caracteres",
    "Issuer": "MicroAuth",
    "Audience": "MicroAuthUsers"
  },
  "Crypto": {
    "Key": "chave-legada",
    "IV": "iv-legado",
    "NewKey": "chave-nova-32-caracteres"
  },
  "Email": {
    "Host": "smtp.gmail.com",
    "Port": 587,
    "Username": "seu-email@gmail.com",
    "Password": "senha-app",
    "From": "noreply@empresa.com"
  },
  "FuncionarioApi": {
    "BaseUrl": "http://localhost:7000"
  }
}
```

### Executando o Projeto

```bash
# Restaurar dependÃªncias
dotnet restore

# Aplicar migraÃ§Ãµes do banco
dotnet ef database update

# Executar
dotnet run

# Acessar
# http://localhost:5000/api/auth
```

### Docker

```bash
# Build
docker build -t auth-api .

# Run
docker run -p 5000:8080 \
  -e DATABASE_URL="..." \
  -e JWT_KEY="..." \
  auth-api
```

---

## ğŸ“ ObservaÃ§Ãµes Importantes

### DiferenÃ§a entre Sistemas

- Cada **sistema** Ã© um microsserviÃ§o/aplicaÃ§Ã£o diferente
- UsuÃ¡rios podem ter permissÃµes diferentes em cada sistema
- Tokens JWT sÃ£o especÃ­ficos para um sistema
- Para acessar outro sistema, Ã© necessÃ¡rio novo login (gera novo token)

### ValidaÃ§Ã£o de FuncionÃ¡rio

- Durante **registro**: CPF deve existir e estar ativo
- Durante **login**: Status do funcionÃ¡rio Ã© verificado em tempo real
- Se funcionÃ¡rio for inativado, usuÃ¡rio Ã© automaticamente inativado

### SessÃµes MÃºltiplas

- Um usuÃ¡rio pode ter vÃ¡rias sessÃµes ativas (diferentes dispositivos)
- Cada sessÃ£o tem seu prÃ³prio refresh token
- Logout individual: invalida apenas a sessÃ£o atual
- Logout global: invalida todas as sessÃµes

### ExpiraÃ§Ã£o de Tokens

- **Access Token (JWT)**: 15 minutos
- **Refresh Token**: 30 dias
- **CÃ³digo 2FA**: 5 minutos
- **Token de Troca de Senha**: 10 minutos

---

## ğŸ“ Suporte

Para dÃºvidas ou problemas, entre em contato com a equipe de desenvolvimento.

**VersÃ£o da API:** 1.1
**Ãšltima AtualizaÃ§Ã£o:** 17/11/2025

---

## ğŸ“ Changelog

### v1.1 (17/11/2025)

**Novos Endpoints:**
- `GET /verificar-usuario-por-cpf/{cpf}` - Verifica existÃªncia de usuÃ¡rio por CPF
- `PUT /api/usuarios/{usuarioId}/permissoes` - Atualiza permissÃµes de usuÃ¡rio

**Melhorias:**
- âœ… Fluxo de registro em 2 etapas (verificaÃ§Ã£o + atribuiÃ§Ã£o de permissÃµes)
- âœ… Endpoint de registro retorna 409 Conflict quando CPF jÃ¡ existe
- âœ… Cache em memÃ³ria para permissÃµes (TTL: 15 minutos)
- âœ… Retry policy com Polly para API externa (3 tentativas com exponential backoff)
- âœ… Ãndices de banco de dados otimizados
- âœ… Exception Handler Middleware para tratamento global de erros
- âœ… Security Headers Middleware para proteÃ§Ã£o adicional
- âœ… Campo `ultimo_login` agora Ã© atualizado corretamente apÃ³s 2FA

**Performance:**
- Consultas de permissÃµes ~70% mais rÃ¡pidas (cache)
- Busca por CPF ~90% mais rÃ¡pida (Ã­ndice Ãºnico)
- ResiliÃªncia contra falhas transientes na API externa

### v1.0 (12/11/2025)
- VersÃ£o inicial da API de autenticaÃ§Ã£o
