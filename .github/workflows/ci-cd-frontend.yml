# ğŸ¨ CI/CD - Frontend CAC
# Testes, Lint, Build e Push versionado para Docker Hub

name: ğŸ¨ CI/CD - Frontend CAC

on:
  push:
    branches: [develop, staging, master]
  pull_request:
    branches: [develop, staging, master]

env:
  REGISTRY: docker.io
  IMAGE_NAME: cac-frontend

jobs:
  # ğŸ§ª QUALIDADE DE CÃ“DIGO E TESTES
  quality-check:
    name: ğŸ§ª Quality Check & Tests
    runs-on: ubuntu-latest

    steps:
      - name: ğŸ“¥ Checkout Code
        uses: actions/checkout@v4

      - name: ğŸ“¦ Install pnpm
        uses: pnpm/action-setup@v4
        with:
          run_install: false

      - name: ğŸ”§ Setup Node.js 20
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'pnpm'

      - name: ğŸ“¦ Install Dependencies
        run: pnpm install --frozen-lockfile

      - name: ğŸ” Code Quality Check
        run: |
          echo "ğŸ” Running ESLint..."
          pnpm lint
          echo "âœ… ESLint passed!"

      - name: ğŸ¨ Format Check
        continue-on-error: true
        run: |
          echo "ğŸ¨ Checking code formatting..."
          if pnpm format:check; then
            echo "âœ… Code formatting is correct!"
          else
            echo "âš ï¸ Code formatting issues found - consider running 'pnpm format'"
            echo "::warning::Code formatting issues detected. Run 'pnpm format' to fix automatically."
          fi

      # ğŸ’¡ DESCOMENTE PARA TORNAR FORMATAÃ‡ÃƒO OBRIGATÃ“RIA:
      # - name: ğŸ¨ Format Check (Strict)
      #   run: |
      #     echo "ğŸ¨ Checking code formatting (strict mode)..."
      #     pnpm format:check
      #     echo "âœ… Code formatting is correct!"

      - name: ğŸ—ï¸ TypeScript Build Check
        run: |
          echo "ğŸ—ï¸ Checking TypeScript compilation..."
          pnpm build
          echo "âœ… TypeScript build successful!"

      - name: ğŸ§ª Run Tests
        run: |
          echo "ğŸ§ª Running Vitest tests..."
          pnpm test --run --reporter=verbose --coverage=false
          echo "âœ… All tests passed!"

  # ğŸ³ BUILD E PUSH VERSIONADO
  build-and-push:
    name: ğŸ³ Build & Push Versioned Image
    runs-on: ubuntu-latest
    needs: quality-check
    if: github.event_name == 'push'

    steps:
      - name: ğŸ“¥ Checkout Code
        uses: actions/checkout@v4

      - name: ğŸ”§ Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: ğŸ” Login to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}

      - name: ğŸ·ï¸ Generate Version Tags
        id: meta
        run: |
          # Gera timestamp para versionamento
          TIMESTAMP=$(date +%Y%m%d-%H%M%S)
          SHORT_SHA=$(echo ${{ github.sha }} | cut -c1-7)
          BRANCH_NAME=$(echo ${{ github.ref_name }} | sed 's/[^a-zA-Z0-9]/-/g')

          # Tags baseadas na branch
          BASE_TAG="${{ env.REGISTRY }}/${{ secrets.DOCKER_USERNAME }}/${{ env.IMAGE_NAME }}"

          if [[ "${{ github.ref_name }}" == "main" ]]; then
            # Production: v1.0.0, v1.0.0-abc1234, latest
            VERSION="v1.0.${GITHUB_RUN_NUMBER}"
            TAGS="${BASE_TAG}:${VERSION}"
            TAGS="${TAGS},${BASE_TAG}:${VERSION}-${SHORT_SHA}"
            TAGS="${TAGS},${BASE_TAG}:latest"
            TAGS="${TAGS},${BASE_TAG}:stable"
          elif [[ "${{ github.ref_name }}" == "staging" ]]; then
            # Staging: staging-v1.0.0, staging-timestamp
            VERSION="staging-v1.0.${GITHUB_RUN_NUMBER}"
            TAGS="${BASE_TAG}:${VERSION}"
            TAGS="${TAGS},${BASE_TAG}:staging-${TIMESTAMP}"
            TAGS="${TAGS},${BASE_TAG}:staging"
          else
            # Development: develop-timestamp, develop-sha
            TAGS="${BASE_TAG}:develop-${TIMESTAMP}"
            TAGS="${TAGS},${BASE_TAG}:develop-${SHORT_SHA}"
            TAGS="${TAGS},${BASE_TAG}:develop"
          fi

          echo "ğŸ·ï¸ Tags geradas: ${TAGS}"
          echo "tags=${TAGS}" >> $GITHUB_OUTPUT
          echo "version=${VERSION:-develop-${TIMESTAMP}}" >> $GITHUB_OUTPUT
          echo "timestamp=${TIMESTAMP}" >> $GITHUB_OUTPUT

      - name: ğŸ³ Build and Push to Docker Hub
        uses: docker/build-push-action@v5
        with:
          context: .
          file: Dockerfile
          platforms: linux/amd64
          push: true
          tags: ${{ steps.meta.outputs.tags }}
          cache-from: type=gha
          cache-to: type=gha,mode=max
          build-args: |
            NODE_ENV=production
            BUILD_TIME=${{ steps.meta.outputs.timestamp }}
          labels: |
            org.opencontainers.image.title=CAC Frontend
            org.opencontainers.image.description=Interface React/TypeScript para o sistema CAC
            org.opencontainers.image.source=${{ github.repositoryUrl }}
            org.opencontainers.image.revision=${{ github.sha }}
            org.opencontainers.image.version=${{ steps.meta.outputs.version }}
            org.opencontainers.image.created=${{ steps.meta.outputs.timestamp }}

      - name: ğŸ“‹ Summary
        run: |
          echo "## ğŸ‰ Build ConcluÃ­do com Sucesso!" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ğŸ“¦ Imagem Gerada:" >> $GITHUB_STEP_SUMMARY
          echo "- **VersÃ£o:** \`${{ steps.meta.outputs.version }}\`" >> $GITHUB_STEP_SUMMARY
          echo "- **Tags:** \`${{ steps.meta.outputs.tags }}\`" >> $GITHUB_STEP_SUMMARY
          echo "- **Branch:** \`${{ github.ref_name }}\`" >> $GITHUB_STEP_SUMMARY
          echo "- **Commit:** \`${{ github.sha }}\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ğŸ³ Como usar:" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`bash" >> $GITHUB_STEP_SUMMARY
          echo "docker pull ${{ env.REGISTRY }}/${{ secrets.DOCKER_USERNAME }}/${{ env.IMAGE_NAME }}:${{ steps.meta.outputs.version }}" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ğŸŒ Tecnologias:" >> $GITHUB_STEP_SUMMARY
          echo "- **React 19** + TypeScript 5.8" >> $GITHUB_STEP_SUMMARY
          echo "- **Vite 7** + TailwindCSS 4" >> $GITHUB_STEP_SUMMARY
          echo "- **shadcn/ui** + Radix UI" >> $GITHUB_STEP_SUMMARY
          echo "- **pnpm** + Vitest" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ğŸ”— Links:" >> $GITHUB_STEP_SUMMARY
          echo "- [Docker Hub](https://hub.docker.com/r/${{ secrets.DOCKER_USERNAME }}/${{ env.IMAGE_NAME }})" >> $GITHUB_STEP_SUMMARY
          echo "- [RepositÃ³rio](${{ github.repositoryUrl }})" >> $GITHUB_STEP_SUMMARY

  # ğŸ” ANÃLISE DE SEGURANÃ‡A E QUALIDADE
  security-analysis:
    name: ğŸ” Security & Quality Analysis
    runs-on: ubuntu-latest
    needs: quality-check
    if: github.event_name == 'push' && github.ref_name == 'main'

    steps:
      - name: ğŸ“¥ Checkout Code
        uses: actions/checkout@v4

      - name: ğŸ“¦ Install pnpm
        uses: pnpm/action-setup@v4
        with:
          run_install: false

      - name: ğŸ”§ Setup Node.js 20
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'pnpm'

      - name: ğŸ“¦ Install Dependencies
        run: pnpm install --frozen-lockfile

      - name: ğŸ” Audit Dependencies
        run: |
          echo "ğŸ” Verificando vulnerabilidades nas dependÃªncias..."
          pnpm audit || echo "âš ï¸ Vulnerabilidades encontradas - revisar antes do deploy"

      - name: ğŸ“Š Bundle Size Analysis
        run: |
          echo "ğŸ“Š Analisando tamanho do bundle..."
          pnpm build
          echo "ğŸ“ Arquivos gerados:"
          ls -la dist/assets/ || echo "DiretÃ³rio dist nÃ£o encontrado"
